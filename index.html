<!DOCTYPE html>
<html>
    <head>
        <!-- meta for the browser to have mobile first design -->
        <meta charset="utf-8" />
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
 

    <title> CIMPL-Corporate and Independently Owned Pharmacy Locator </title>

    <style>
        html,
        body,
        #viewDiv {
         padding: 0;
         margin: 0;
         height: 100%;
         width: 100%;
        }

        .addRecordBtn {
  position: absolute;
  z-index: 10;
  top: 10px;
  right: 10px;
  background-color: #005a87;
  color: white;
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
    font-size: 20px; 
  cursor: pointer;
  text-decoration: none;
}

.addRecordBtn:hover {
  background-color: #00486b;
}

       </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.25/"></script>

        <script>
        require([ "esri/config","esri/Map", "esri/views/MapView", "esri/widgets/Locate", "esri/widgets/Search", "esri/layers/FeatureLayer", "esri/layers/GeoJSONLayer","esri/geometry/geometryEngine", "esri/geometry/Point", "esri/widgets/Legend"
 ], (esriConfig, Map, MapView, Locate, Search, FeatureLayer, GeoJSONLayer, geometryEngine, Point, Legend) => {
            
            esriConfig.apiKey = "AAPK56419a6214b44ea4bcb814fec9ef171eVhAxzMstqNZOcF3t1U-exAFnYlWyzkQVYSOD8xzziKyHegsVdDZxaECBoXxisXR6";

            const map = new Map({
            basemap: "satellite"
            });

            const view = new MapView({
            container: "viewDiv", // Reference to the DOM node that will contain the view
            map: map,
            center: [-82.3475, 29.6436],
            zoom: 13 // Sets the zoom level based on level of detail (LOD)
            });

            const locateBtn = new Locate({
          view: view
        });

        // Add the locate widget to the bottom left corner of the view
        view.ui.add(locateBtn, {
          position: "bottom-left"
        });

        

         const searchWidget = new Search({
        view: view
        });
        // Adds the search widget below other elements in
        // the bottom left corner of the view
        // next to locate me widget
        view.ui.add(searchWidget, {
          position: "bottom-left",
         index: 2
        });

// Create featurelayer from feature service 
const layer = new FeatureLayer({ 
  // URL to the service 
   url: "https://services.arcgis.com/LBbVDC0hKPAnLRpO/arcgis/rest/services/survey123_b16781eee7944077be2600f7e6a68bdc_results/FeatureServer",  //Your item URL Goes Here
   renderer: {  // Renderer definition
    type: "unique-value",  // autocasts as new SimpleRenderer()
    field: "please_select_your_income_level",  // The field to use for the unique values
  uniqueValueInfos: [
    {
      value: "0 to $11,600",  // The value of the 'type' field for the first type of features
      symbol: {  // The symbol to use for the first type of features
        type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
        style: "circle",
        color: "green",
        size: "12px"
      }
    },

    {
      value: "$11,601 to $47,150",  // The value of the 'type' field for the first type of features
      symbol: {  // The symbol to use for the first type of features
        type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
        style: "circle",
        color: "yellow",
        size: "12px"
      }
    },

    {
      value: "$47,150 to $100,525",  // The value of the 'type' field for the first type of features
      symbol: {  // The symbol to use for the first type of features
        type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
        style: "circle",
        color: "orange",
        size: "12px"
      }
    },

    {
      value: "$100,525 to $191,950",  // The value of the 'type' field for the first type of features
      symbol: {  // The symbol to use for the first type of features
        type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
        style: "circle",
        color: "red",
        size: "12px"
      }
    },

    {
      value: "$191,950 to $243,725",  // The value of the 'type' field for the first type of features
      symbol: {  // The symbol to use for the first type of features
        type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
        style: "circle",
        color: "purple",
        size: "12px"
      }
    },

    {
      value: "$243,725 to $609,350",  // The value of the 'type' field for the first type of features
      symbol: {  // The symbol to use for the first type of features
        type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
        style: "circle",
        color: "blue",
        size: "12px"
      }
    },

    {
      value: "Over $609,350",  // The value of the 'type' field for the first type of features
      symbol: {  // The symbol to use for the first type of features
        type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
        style: "circle",
        color: "brown",
        size: "12px"
      }
    },
  ]
  }
})
map.add(layer);

// Create a GeoJSONLayer from a GeoJSON file
    const url = "https://raw.githubusercontent.com/ceciliaperla/midterm/main/pharmacy_point.geojson"; // Replace with your GeoJSON file URL
      
    const geojsonLayer = new GeoJSONLayer({
  url: url,
  renderer: {
    type: "simple",
    symbol: {
      type: "simple-marker",
      style: "circle",
      color: "blue",
      size: "8px"
    }
  },
  popupTemplate: {
    title: "{name}",
    content: function(feature) {
      // Query the layer for all other points
      return geojsonLayer.queryFeatures({
        where: "1=1",  // This condition selects all features
        returnGeometry: true,
        outFields: ["*"]
      }).then(function(result) {
        let closestDistance = Infinity;
        let closestPoint = null;

        function shouldExclude(name) {
          // Array of names to exclude
          let excludeNames = ["csv", "cvs", "cvs pharmacy", "cvs/pharmacy", "publix", "publix groceries", "publix pharmacy", "publix pharmacy at glade crossing", "target pharmacy", "sam's club pharmacy", "walgreens", "walgreens apotheke", "walgreens pharmacy", "wallgreens", "walmart", "walmart neighborhood market", "walmart pharmacy", "walmart supercenter", "winn-dixie", "winn-dixie pharmacy"];

          // Convert the name to lower case and remove any extra spaces
          let cleanedName = name.toLowerCase().trim();

          // Check if the cleaned name is in the excludeNames array
          return excludeNames.includes(cleanedName);
        }
        // Loop through all other points
        for (let otherPoint of result.features) {
        // Skip the selected point itself and pharmacies that should be excluded
        if (otherPoint.attributes.OBJECTID !== feature.graphic.attributes.OBJECTID &&
            !shouldExclude(otherPoint.attributes.name)) {
            // Calculate the distance to the other point
            let distance = geometryEngine.distance(feature.graphic.geometry, otherPoint.geometry, "miles");

            // If the distance is smaller than the current closest distance, update the closest distance and point
            if (distance < closestDistance) {
              closestDistance = distance;
              closestPoint = otherPoint;
            }
          }
        }

        // If a closest point is found, include its information in the popup
        if (closestPoint) {
          return "<b>Address:</b>" + feature.graphic.attributes.addr_stree +
                 "<br><b>Closest Independent Pharmacy:</b>" + closestPoint.attributes.name +
                 "<br><b>Distance:</b>" + closestDistance.toFixed(2) + " miles";
        } else {
          // If no closest point is found (which should not happen), just show the address
          return "<b>Address:</b>" + feature.graphic.attributes.addr_stree;
        }
      });
    }
  }
});

      map.add(geojsonLayer);

  

      // Create a Legend
      let legend = new Legend({
        view: view,
        layerInfos: [
          {
            layer: geojsonLayer,
            title: "Pharmacy Legend"  // Replace with the title you want to use
          }
        ]
      });

      // Add the Legend to the MapView
      view.ui.add(legend, "bottom-right");  // You can change the position if you want

        });
    

        </script>
    

</head>
    <body>
      <a href="https://arcg.is/104v4P"target="_blank" class="addRecordBtn">Add Record</a>

        <div id="viewDiv"></div>
    </body>
</html>